import utils
import db_utils

EXPORT_EDGES_FILE = "graph.edges.csv"
EXPORT_NODES_FILE = "graph.nodes.csv"


def export_graph_data():
    data_file = open(EXPORT_EDGES_FILE, "w")
    db = db_utils.getDBInstance()

    nodes = set([])
    data_file.write("Source;Target\n")
    edges = set([])

    pages = db.webpages.find()
    for page in pages:
        ilinks = page["incoming_links"]
        for link in ilinks:
            if link.startswith("javascript"):
                continue
            if page["url"].startswith("javascript"):
                continue
            link = link.replace(",", "")
            nodes.add(utils.domainOf(link))
            page["url"] = page["url"].replace(",", "")
            nodes.add(utils.domainOf(page["url"]))
            edges.add((utils.domainOf(link), utils.domainOf(page["url"])))
            #data_file.write(("%s\t%s\n"%(link, page["url"])))



    nodes_file = open(EXPORT_NODES_FILE, "w")    

    nodes_file.write("Id;Label\n")
    for node in nodes:
        nodes_file.write("%s;%s\n"%(node, utils.domainOf(node)))
    
    nodes_file.close() 

    for edge in edges:
        data_file.write("%s;%s\n"%(edge[0], edge[1]))

    
    data_file.close()

if __name__ == '__main__':
    export_graph_data()
